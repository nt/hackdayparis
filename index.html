<!html>
<head>
  
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="js/jquery.js"></script>
  <script type="text/javascript" src="js/raphael-min.js"></script>
  <script type="text/javascript" src="js/json2.js"></script>
  <script type="text/javascript" src="js/raphael.sketchpad.js"></script>
  <script type="text/javascript" src="js/jscolor/jscolor.js"></script>
  <script type="text/javascript" src="js/farbtastic/farbtastic.js"></script>
  <link rel="stylesheet" href="js/farbtastic/farbtastic.css" type="text/css" />
  
  <link rel="stylesheet" href="css/hack.css" type="text/css" />
  
</head>



<script>
  // l'url de la page que l'on est en train de hacker
  var hacked_page = ''
  // choppe la page choisi dans l'input et l'affiche dans l'iframe
  function hack_page(){
    hacked_page = $('#hacked_page_input').val()
    $('#hacked_page_iframe').attr('src', hacked_page)
  }
  function toggle_drawing(){
    
  }
  
  // pour gérer les mouvements claviers
	if(jQuery.browser.mozilla){
		jQuery(document).keypress(checkKey)
    // jQuery(document).keyup(checkKey)
	}else{
		jQuery(document).keydown(checkKey)
	}
	
	
  function checkKey(e) {
    if (e.keyCode==32){
      e.preventDefault();
      var pointer_events =  ( ($('#editor').css("pointer-events")=='auto') ? 'none' : 'auto' )
      $('#editor').css("pointer-events", pointer_events)
      $('#navigation_mode').toggle()
      $('#dessin_mode').toggle()
      $('#editor').hide().fadeIn()
    }

    // alert(e.keyCode)
  }
  
</script>


<body>
  
  <!-- le contenu de la page, centré avec une largeur fixée -->
  <div id='main_content'>
  
    <!-- pour le choix de la page à hacker et les tools -->
    <div id='form_container'>
      
      <!-- les outils pour dessiner -->
      <div id='tools_container'>
                
        <!-- <button onclick="">   -->
        <button id="clear">Clear</button>
        <button onclick="$('#colorpicker').fadeToggle()">Change color</button><br />
        <div id="colorpicker"></div>
      </div>
      
      <!-- l'input pour le choix de la page -->
      <form id='select_page_form' onsubmit='return false'>
        <input type='text' id='hacked_page_input' />
        <input type='submit' onclick='hack_page()' value='Go !'/>
        
          <span id='navigation_mode' class='action_mode' style='display:none'>Browsing</span>
          <span id='dessin_mode' class='action_mode'>Drawing</span>
          (use space bar to change mode)
          
          
      </form>
      
    </div>
    
    <!-- div qui contiendra la page désirée avec par dessus un div pour dessiner -->
    <div id='hacked_page_container'>
    
      <!-- le div pour dessiner  -->
      <div id="editor" class="sketchpad"></div>
      
      <!-- l'iframe avec la page à afficher -->
      <iframe id='hacked_page_iframe' src="http://lemonde.fr">
        <p>Your browser does not support iframes.</p>
      </iframe>
      
    </div>
  
  </div>
  
  

  <script type="text/javascript">
  	
  	
  	var thisClientId = "";
  	
  	var presentStrokes = []; // Array containing all the strokes on my canvas
  	
  	
  	$(function(){
  	  
  	  // Connect to drawing server
  	  var socket = io.connect('http://localhost');
  	  
      
      // Create the editor sketchpad
    	var sketchpad = Raphael.sketchpad("editor", {
    		width: 1200,
    		height: 10000,  // doit être le même que le hacked_page_iframe
    		editing: true
    	});
    	var sketchpads = $('.sketchpad');
    	
    	var pen = sketchpad.pen();

    	// add colors
    	$('#colorpicker').farbtastic(sketchpad.pen().color);
    	
    	
    	// Add a helper method to draw on sketchpad without firing the "sketchpad.change" event
    	var listenToChanges = true;
      var silentDraw = function(strokes){
         // ignore changes for a while
      	 listenToChanges = false;

      	 // draw the strokes
         sketchpad.strokes( presentStrokes );
      };
      
    	// Set the clear button
    	$('#clear').click(function(){
        sketchpad.clear();
    	});
      
      // Listen for initial strokes
      socket.on('init', function(strokes){
        presentStrokes = strokes;
        
        silentDraw( presentStrokes );
      });
      
    	// When the server sends me a drawing, draw it in the sketchpad
      socket.on('draw', function (stroke) {
        
        if(stroke){
          // add the stroke to the stack
           presentStrokes.push( stroke );

           // refresh the stack
           silentDraw( presentStrokes );
        }
         
      })


    	// Fired when I draw on my sketchpad
    	sketchpad.change(function() {
        
        // console.log("Change() with listenToChanges="+listenToChanges );
        
        if(listenToChanges){
         
           // get the strokes
          var strokesArray = sketchpad.strokes();

          // the last stroke is the one I drew
          var lastStroke = strokesArray[strokesArray.length-1];

          // clean the stroke: remove any weird paths (i.e. with negative values)
          var cleanPaths = [];
          // console.log("Going through the paths:\n");
          $.each(lastStroke.path, function(position,path){

           console.log(JSON.stringify(path));

           // TODO: remove weird points (not necessarly negative values... just weird ones -> zig zag effect)
           if(path[1]>0 && path[2]>0){
             // console.log("Pushing it\n");
             cleanPaths.push(path);
           }
           else{
             // console.log("Not pushing it\n");
           }

          })
         
         
         // console.log('cleanPaths = '+JSON.stringify(cleanPaths));
         lastStroke.path = cleanPaths;
         
         // add my client id to the stroke (the server will override this but locally it will be usefull to remember my strokes)
         lastStroke.clientId = "me";
         
         // send the stroke to the server
         socket.emit("drawThis", lastStroke );
         
         // add the stroke to the stack
         presentStrokes.push( lastStroke );
         
         // refresh the stack
         silentDraw( presentStrokes );
         
        }
    	  else{
    	    listenToChanges = true;
    	  }

    	})
    	
  	})
  </script>
  

</body>