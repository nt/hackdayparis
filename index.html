<!html>
<head>
  
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript" src="js/jquery.js"></script>
  <script type="text/javascript" src="js/raphael-min.js"></script>
  <script type="text/javascript" src="js/json2.js"></script>
  <script type="text/javascript" src="js/raphael.sketchpad.js"></script>
  <script type="text/javascript" src="js/jscolor/jscolor.js"></script>
  <script type="text/javascript" src="js/farbtastic/farbtastic.js"></script>
  <link rel="stylesheet" href="js/farbtastic/farbtastic.css" type="text/css" />
  
  <link rel="stylesheet" href="css/hack.css" type="text/css" />
  
</head>



<script>
  // l'url de la page que l'on est en train de hacker
  var hacked_page = ''
  // choppe la page choisi dans l'input et l'affiche dans l'iframe
  function hack_page(){
    hacked_page = $('#hacked_page_input').val()
    $('#hacked_page_iframe').attr('src', hacked_page)
  }
  function toggle_drawing(){
    
  }
  
  // pour gérer les mouvements claviers
	if(jQuery.browser.mozilla){
		jQuery(document).keypress(checkKey)
    // jQuery(document).keyup(checkKey)
	}else{
		jQuery(document).keydown(checkKey)
	}
	
	
  function checkKey(e) {
    if (e.keyCode==32){
      e.preventDefault();
      var pointer_events =  ( ($('#editor').css("pointer-events")=='auto') ? 'none' : 'auto' )
      $('#editor').css("pointer-events", pointer_events)
      $('#navigation_mode').toggle()
      $('#dessin_mode').toggle()
      $('#editor').hide().fadeIn()
    }

    // alert(e.keyCode)
  }
  
</script>


<body>
  
  <!-- le contenu de la page, centré avec une largeur fixée -->
  <div id='main_content'>
  
    <!-- pour le choix de la page à hacker et les tools -->
    <div id='form_container'>
      
      <!-- les outils pour dessiner -->
      <div id='tools_container'>
                
        <!-- <button onclick="">   -->
          
        <button onclick="$('#colorpicker').fadeToggle()">Change color</button><br />
        <div id="colorpicker"></div>
      </div>
      
      <!-- l'input pour le choix de la page -->
      <form id='select_page_form' onsubmit='return false'>
        <input type='text' id='hacked_page_input' />
        <input type='submit' onclick='hack_page()' value='Go !'/>
        
          <span id='navigation_mode' class='action_mode' style='display:none'>Browsing</span>
          <span id='dessin_mode' class='action_mode'>Drawing</span>
          (use space bar to change mode)
          
          
      </form>
      
    </div>
    
    <!-- div qui contiendra la page désirée avec par dessus un div pour dessiner -->
    <div id='hacked_page_container'>
    
      <!-- le div pour dessiner  -->
      <div id="editor" class="sketchpad"></div>
      
      <!-- l'iframe avec la page à afficher -->
      <iframe id='hacked_page_iframe' src="http://lemonde.fr">
        <p>Your browser does not support iframes.</p>
      </iframe>
      
    </div>
  
  </div>
  
  

  <script type="text/javascript">
  	
  	$(function(){
  	  
  	  // Connect to drawing server
  	  var socket = io.connect('http://localhost');
      
      // Create the editor sketchpad
    	var sketchpad = Raphael.sketchpad("editor", {
    		width: 1200,
    		height: 10000,  // doit être le même que le hacked_page_iframe
    		editing: true
    	});
    	
    	var pen = sketchpad.pen();

      var listenToChanges = true;
      
    	// When the server sends me a drawing, draw it in the sketchpad
      socket.on('draw', function (data) {
        
        listenToChanges = false;
        sketchpad.strokes(data.strokes);
        
      });

    	// When the sketchpad changes, send the drawing to the server
    	sketchpad.change(function() {
        
        if(listenToChanges){
         socket.emit("drawThis",{ strokes: sketchpad.strokes()}); 
        }
    	  else{
    	    listenToChanges = true;
    	  }

    	})
    	
    	// Set styles
      var sketchpads = $('.sketchpad');
    	
    	// add colors
    	$('#colorpicker').farbtastic(sketchpad.pen().color);

  	});
  </script>
  
  
  

</body>